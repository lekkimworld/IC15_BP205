DISCONNECT ALL;
DROP DB COMMCAL;

CREATE DB COMMCAL;
CONNECT TO COMMCAL;

CREATE SCHEMA COMMCAL;

CREATE TABLE COMMCAL.CONFIGURATION (KEY VARCHAR(128) NOT NULL, VALUE VARCHAR(128) NOT NULL);

CREATE TABLE COMMCAL.EVENT (EVENT_ID VARCHAR(40) NOT NULL PRIMARY KEY, EVENT_TYPE CHAR(1) NOT NULL DEFAULT 'C', COMM_ID VARCHAR(40) NOT NULL, START_DT TIMESTAMP NOT NULL, END_DT TIMESTAMP NOT NULL, ALLDAY CHAR(1) DEFAULT '0', LOCATION VARCHAR(256), SUBJECT VARCHAR(256) NOT NULL, URL VARCHAR(256) NOT NULL);
CREATE TABLE COMMCAL.COMMUNITY (COMM_ID VARCHAR(40) NOT NULL PRIMARY KEY, COMM_NAME VARCHAR(256) NOT NULL);
CREATE TABLE COMMCAL.USER (USER_KEY VARCHAR(64) NOT NULL PRIMARY KEY, UID VARCHAR(64) NOT NULL, EMAIL VARCHAR(256) NOT NULL);
CREATE TABLE COMMCAL.USER_COMMUNITY (USER_KEY VARCHAR(64) NOT NULL, COMM_ID VARCHAR(256) NOT NULL, AUTO_ACTION CHAR(1) DEFAULT NULL);
ALTER TABLE COMMCAL.USER_COMMUNITY ADD PRIMARY KEY (USER_KEY, COMM_ID);
CREATE TABLE COMMCAL.USER_EVENT (USER_KEY VARCHAR(64) NOT NULL, EVENT_ID VARCHAR(40) NOT NULL, ACTION CHAR(1) NOT NULL, UNID VARCHAR(64));
ALTER TABLE COMMCAL.USER_EVENT ADD PRIMARY KEY (USER_KEY, EVENT_ID);
ALTER TABLE COMMCAL.EVENT ADD FOREIGN KEY (COMM_ID) REFERENCES COMMCAL.COMMUNITY (COMM_ID);
ALTER TABLE COMMCAL.USER_COMMUNITY ADD FOREIGN KEY (USER_KEY) REFERENCES COMMCAL.USER (USER_KEY) ON DELETE CASCADE;
ALTER TABLE COMMCAL.USER_COMMUNITY ADD FOREIGN KEY (COMM_ID) REFERENCES COMMCAL.COMMUNITY (COMM_ID) ON DELETE CASCADE;
ALTER TABLE COMMCAL.USER_EVENT ADD FOREIGN KEY (USER_KEY) REFERENCES COMMCAL.USER (USER_KEY) ON DELETE CASCADE;
ALTER TABLE COMMCAL.USER_EVENT ADD FOREIGN KEY (EVENT_ID) REFERENCES COMMCAL.EVENT (EVENT_ID) ON DELETE CASCADE;

CREATE TABLE COMMCAL.TOKENS (USER_KEY VARCHAR(128) NOT NULL, ACCESS_TOKEN VARCHAR(256), REFRESH_TOKEN VARCHAR(256) NOT NULL);

GRANT ALL ON COMMCAL.TOKENS TO LCUSER;
GRANT ALL ON COMMCAL.EVENT TO LCUSER;
GRANT ALL ON COMMCAL.COMMUNITY TO LCUSER;
GRANT ALL ON COMMCAL.USER TO LCUSER;
GRANT ALL ON COMMCAL.USER_COMMUNITY TO LCUSER;
GRANT ALL ON COMMCAL.USER_EVENT TO LCUSER;
GRANT ALL ON COMMCAL.CONFIGURATION TO LCUSER;

DISCONNECT ALL;
